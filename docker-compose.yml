# ================================
# Docker Compose para PRODUCCIÓN (Dokploy)
# ================================
# Este archivo está optimizado para deployment en Dokploy/Hostinger
#
# IMPORTANTE PARA DOKPLOY:
# 1. Dokploy usa este archivo automáticamente desde la raíz del proyecto
# 2. PostgreSQL se configura como servicio separado en Dokploy UI
# 3. Frontend se despliega como aplicación separada en Dokploy
# 4. Las variables de entorno se configuran en Dokploy UI (ver backend/.env.example)
# 5. Dokploy maneja automáticamente los certificados SSL con Let's Encrypt
#
# PARA DESARROLLO LOCAL:
# Use: docker-compose -f docker-compose.dev.yml up
# ================================

version: '3.8'

services:
  # ================================
  # Backend API (NestJS)
  # ================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
      args:
        NODE_ENV: production
    image: rapido-sur-backend:latest
    container_name: rapido-sur-backend
    restart: always

    # Port mapping
    ports:
      - '${PORT:-3000}:3000'

    # ================================
    # Environment Variables
    # IMPORTANT: Configure these in Dokploy UI
    # DO NOT hardcode sensitive values here
    # ================================
    environment:
      # Application Settings
      NODE_ENV: production
      PORT: ${PORT:-3000}

      # Database Connection (Dokploy PostgreSQL service)
      # Dokploy will provide these values through its UI
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-5432}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}

      # JWT Authentication
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-24h}

      # CORS Configuration
      FRONTEND_URL: ${FRONTEND_URL}

      # Email Configuration
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_SECURE: ${MAIL_SECURE:-false}
      MAIL_USER: ${MAIL_USER}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_FROM: ${MAIL_FROM:-noreply@rapidosur.cl}

      # Maintenance Alerts
      MAINTENANCE_MANAGER_EMAIL: ${MAINTENANCE_MANAGER_EMAIL}
      ENABLE_CRON: ${ENABLE_CRON:-true}
      ALERTS_CRON_SCHEDULE: ${ALERTS_CRON_SCHEDULE:-0 6 * * *}

      # Logging & Monitoring
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Rate Limiting
      THROTTLE_TTL: ${THROTTLE_TTL:-60000}
      THROTTLE_LIMIT: ${THROTTLE_LIMIT:-10}

    # ================================
    # Persistent Volumes (Dokploy pattern)
    # Using ../files/ ensures data persists across deployments
    # ================================
    volumes:
      - ../files/backend-logs:/app/logs

    # ================================
    # Health Check
    # ================================
    healthcheck:
      test: ['CMD-SHELL', 'node -e "require(\"http\").get(\"http://localhost:3000/health\", (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # ================================
    # Logging Configuration
    # ================================
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '5'
        compress: 'true'

    # ================================
    # Resource Limits (Optional)
    # Uncomment if needed for your VPS
    # ================================
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

# ================================
# NOTA IMPORTANTE:
# ================================
# PostgreSQL y Frontend NO están incluidos aquí porque:
# - PostgreSQL: Dokploy lo proporciona como servicio administrado separado
# - Frontend: Se despliega como aplicación separada en Dokploy para mejor escalabilidad
#
# Para desarrollo local completo use:
# docker-compose -f docker-compose.dev.yml up
# ================================
