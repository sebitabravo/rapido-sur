# ================================
# Docker Compose COMPLETO - Desarrollo Local
# ================================
# Este archivo levanta el stack completo:
# - PostgreSQL 15
# - Backend (NestJS)
# - Frontend (React) - PLACEHOLDER para cuando lo desarrolles
# - pgAdmin (herramienta de gestiÃ³n de BD)
#
# USO:
# docker-compose -f docker-compose.full.yml up -d
# docker-compose -f docker-compose.full.yml down
#
# PUERTOS:
# - Backend:  http://localhost:3000
# - Frontend: http://localhost:8080
# - pgAdmin:  http://localhost:5050
# - PostgreSQL: localhost:5432
# ================================

version: '3.8'

services:
  # ================================
  # PostgreSQL Database
  # ================================
  postgres:
    image: postgres:15-alpine
    container_name: rapido-sur-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      POSTGRES_DB: rapido_sur
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - rapido-sur-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # Backend API (NestJS)
  # ================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    container_name: rapido-sur-backend
    restart: always
    ports:
      - '3000:3000'
    environment:
      # Application
      NODE_ENV: development
      PORT: 3000

      # Database (use postgres service name as host)
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: postgres
      DB_PASSWORD: postgres123
      DB_DATABASE: rapido_sur

      # JWT
      JWT_SECRET: dev_secret_key_change_in_production_12345
      JWT_EXPIRATION: 24h

      # CORS
      FRONTEND_URL: http://localhost:8080

      # Email (development - disabled)
      MAIL_HOST: smtp.gmail.com
      MAIL_PORT: 587
      MAIL_SECURE: false
      MAIL_USER: dev@rapidosur.cl
      MAIL_PASSWORD: devpassword
      MAIL_FROM: noreply@rapidosur.cl
      MAINTENANCE_MANAGER_EMAIL: manager@rapidosur.cl

      # Cron (disabled in development to avoid spam)
      ENABLE_CRON: false

      # Logging
      LOG_LEVEL: debug

      # Rate Limiting (more permissive in dev)
      THROTTLE_TTL: 60000
      THROTTLE_LIMIT: 100
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - rapido-sur-network
    healthcheck:
      test: ['CMD-SHELL', 'node -e "require(\"http\").get(\"http://localhost:3000/health\", (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ================================
  # Frontend (Next.js)
  # NOTA: Descomenta cuando desarrolles el frontend
  # ================================
  # frontend:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #     target: production
  #   container_name: rapido-sur-frontend
  #   restart: always
  #   ports:
  #     - '8080:3000'
  #   environment:
  #     NEXT_PUBLIC_API_URL: http://localhost:3000/api
  #   networks:
  #     - rapido-sur-network
  #   depends_on:
  #     - backend

  # ================================
  # pgAdmin - Database Management UI
  # ================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: rapido-sur-pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@rapidosur.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - '5050:80'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - rapido-sur-network
    depends_on:
      - postgres

# ================================
# Volumes
# ================================
volumes:
  postgres_data:
    driver: local
    name: rapido-sur-postgres-data
  pgadmin_data:
    driver: local
    name: rapido-sur-pgadmin-data

# ================================
# Networks
# ================================
networks:
  rapido-sur-network:
    driver: bridge
    name: rapido-sur-network
